<?php


class		pudlCacheResult
	extends	pudlResult {




	////////////////////////////////////////////////////////////////////////////
	// CONSTRUCTOR
	////////////////////////////////////////////////////////////////////////////
	public function __construct(pudl $pudl, $data, $key) {
		parent::__construct($pudl, count($data));
		$this->rows	= $data;
		$this->key	= $key;
		$this->row	= 0;
	}




	////////////////////////////////////////////////////////////////////////////
	// PURGE THE CACHED RESULTS FROM REDIS
	////////////////////////////////////////////////////////////////////////////
	public function purge() {
		$this->pudl->purge($this->key);
	}




	////////////////////////////////////////////////////////////////////////////
	// FREE RESOURCES ASSOCIATED WITH THIS RESULT
	////////////////////////////////////////////////////////////////////////////
	public function free() {
		$this->rows = [];
		$this->result = false;
	}




	////////////////////////////////////////////////////////////////////////////
	// GET A SINGLE CELL FROM THIS RESULT
	////////////////////////////////////////////////////////////////////////////
	public function cell($row=0, $column=0) {
		$this->seek($row);
		if (!isset($this->rows[$this->row])) return ;

		$this->data = &$this->rows[$row];
		if (count($this->data) < $column) return false;

		//Thanks to PHP's requirement of reset() needing
		//the array to be passed by reference, we have
		//to assign said array to a temporary variable
		$slice = array_slice($this->data, $column, 1);
		return reset($slice);
	}




	////////////////////////////////////////////////////////////////////////////
	// PHP'S COUNTABLE - GET THE NUMBER OF ROWS FROM THIS RESULT
	// http://php.net/manual/en/countable.count.php
	////////////////////////////////////////////////////////////////////////////
	public function _count() {
		return count($this->rows);
	}




	////////////////////////////////////////////////////////////////////////////
	// GET THE NUMBER OF FIELD COLUMNS IN THIS RESULT
	////////////////////////////////////////////////////////////////////////////
	public function fields() {
		if (empty($this->rows)) return false;
		return array_keys($this->rows[0]);
	}




	////////////////////////////////////////////////////////////////////////////
	// GET DETAILS ON A PARTICULAR FIELD COLUMN IN THIS RESULT
	////////////////////////////////////////////////////////////////////////////
	public function getField($column) {
		$fields = $this->fields();
		if (empty($fields[$column])) return false;
		return $fields[$column];
	}




	////////////////////////////////////////////////////////////////////////////
	// PHP'S SEEKABLEITERATOR - JUMP TO A ROW IN THIS RESULT
	// http://php.net/manual/en/seekableiterator.seek.php
	////////////////////////////////////////////////////////////////////////////
	public function _seek($row) {
		$this->row = (int) $row;
	}




	////////////////////////////////////////////////////////////////////////////
	// MOVE TO THE NEXT ROW IN THIS RESULT AND RETURN THAT ROW'S DATA
	////////////////////////////////////////////////////////////////////////////
	public function row() {
		if (isset($this->rows[$this->row])) {
			return $this->data = $this->rows[$this->row++];
		}
		return $this->data = false;
	}




	////////////////////////////////////////////////////////////////////////////
	// RETURN THE RAW DATA
	////////////////////////////////////////////////////////////////////////////
	public function rows() {
		return $this->rows;
	}




	////////////////////////////////////////////////////////////////////////////
	// MEMBER VARIABLES
	////////////////////////////////////////////////////////////////////////////
	protected $rows;
	protected $key;

}
